<!DOCTYPE html>
<html>
<head>
    <title>Telemetry - Pronghorn</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <script src="js/viz-lite.js"></script>
    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery-minimap.js"></script>
    <link rel="stylesheet" type="text/css" href="bootstrap.min.css">
    <style type="text/css">
        html {
            height: 100%;
            overflow: hidden;
            user-select: none;
        }
        body {
            height: 100%;
            overflow: auto;
            font-size: 15px;
        }
        #demo {
            padding-top: 65px;
            text-align: center;
        }
        #loading {
            position: fixed;
            z-index: 0.5;
            background-color: rgba(0, 0, 0, 0.377);
            padding: 5px;
            border-radius: 10px;
            top: 45%;
            left: 45%;
        }
        #loading img {
            width: 64px;
        }
        .bg-oci {
            background: #0f53b3;
            box-shadow: 0px 0px 7px rgba(0,0,0,0.4);
        }
        .nav-link img {
            width: 30px;
        }
        .navbar {
            padding: 0px;
        }
        .navbar-dark .navbar-nav .nav-link {
            color: rgb(255, 255, 255);
        }
        .navbar-dark .navbar-nav .nav-link img {
            margin-right: 5px;
        }
        .divider-vertical {
            height: 50px;
            margin: 0px 9px;
            border-left: 1px solid rgba(242, 242, 242, 0.671);
        }
		#minimap {
            position: fixed;
            top: 70px;
            left: 20px;
			background-color: #EEE;
			border: 1px solid #AAA;
			opacity: 0.9;
			z-index: 1;
            border-radius: 5px;
		}
		.minimap-node {
			position: absolute;
            background-color: #ffffff;
		}
		.minimap-viewport {
			position: absolute;
			box-sizing: border-box;
			border: 2px solid #0f53b3;
            border-radius: 3px;
            box-shadow: 0px 3px 5px rgba(0, 0, 0, 0.664);
			z-index: 1;
			cursor: move;
		}
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-md navbar-dark bg-oci fixed-top">
        <div class="collapse navbar-collapse" id="navbarOCIDefault">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="refresh-rate-dropdown-btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <img src="img/speed.png" alt="Change Interval" />
                        <span class="refresh-label">1 sec</span>
                    </a>
                    <div id="refresh-rate-dropdown" class="dropdown-menu dropdown-right" aria-labelledby="refreshRateDropdown">
                        <a class="dropdown-item" href="#" data-interval="0">No refresh</a>
                        <a class="dropdown-item" href="#" data-interval="160">160 ms</a>
                        <a class="dropdown-item active" href="#" data-interval="1000">1 sec</a>
                        <a class="dropdown-item" href="#" data-interval="20000">20 sec</a>
                        <a class="dropdown-item" href="#" data-interval="60000">1 min</a>
                        <a class="dropdown-item" href="#" data-interval="1200000">20 min</a>
                        <a class="dropdown-item" href="#" data-interval="3600000">1 hour</a>
                    </div>
                </li>
                <li class="divider-vertical"></li>
                <li class="nav-item"><a class="nav-link" id="preview-btn" href="#"><img src="img/preview.png" alt="Show/Hide Preview" /></a></li>
                <li class="divider-vertical"></li>
                <li class="nav-item"><a class="nav-link" href="#" id="zoom-in-btn"><img src="img/zoom-in.png" alt="Zoom In" /></a></li>
                <li class="nav-item"><a class="nav-link" href="#" id="zoom-out-btn"><img src="img/zoom-out.png" alt="Zoom Out" /></a></li>
                <li class="divider-vertical"></li>
                <li class="nav-item"><a class="nav-link" href="#" id="download-btn"><img src="img/download.png" alt="Download SVG" /></a></li>
            </ul>
        </div>
    </nav>
    <main role="main">
        <div id="minimap"></div>
        <div id="demo">
            <div id="loading">
                <img src="img/spinner.svg" />
            </div>
        </div>
        <div class="modal fade" id="errorModal" data-backdrop="static">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-body">
                        <div class="alert alert-danger" style="margin-bottom: 0px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script type="text/javascript">
        $(".navbar,#minimap").hide();

        function httpGet(theUrl, onSuccess, onError) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.timeout = 2000;
            xmlHttp.onreadystatechange = function() {
                if (this.readyState === 4) {
                    if (this.status >= 200 && this.status < 300) {
                        onSuccess(this.responseText);
                    } else{
                        onError("Received " + this.status + " from server.");
                    }
                }
            };
            xmlHttp.open("GET", theUrl, true );
            xmlHttp.send();
        }

        var errorShown = false;

        function showError(message) {
            if(!errorShown) {
                $('#errorModal').modal('show');
                $('#errorModal .alert').html(message + " | Retrying...");
                errorShown = true;
            }
        }

        function hideError() {
            if(errorShown) {
                $('#errorModal').modal('hide');
                $('.modal-backdrop').hide();

                errorShown = false;
            }
        }

        var doingUpdate = false;
        var interval = 1000;

        function doUpdate() {
            if (!doingUpdate || !paintAllDrawing) {
                doingUpdate = true;
                httpGet("graph.dot", paintParts, handleError);
            } else {
                doUpdate();
            }
        }

        var webworker;
        if (window.Worker) {
            webworker = new Worker("webworker.js");
        }

        function handleError(error) {
            console.log('Error: ' + error);
            showError("Error: " + error);

            doingUpdate = false;
        }

        var isFirst = true;
        var paintingTimer;
        var paintAllDrawing = false;
        var webworkerInProgress = false;
        var paintAllinProgress = false;

        var previewScale = 0.07;

        var zoomWidth = 500; //zoom is WIP
        var zoomHeight = 500;

        var zoomStep = 15;

        function paintAll () {
            paintAllinProgress = true;
            if (webworker) {
                if (!webworkerInProgress){
                    webworkerInProgress = true;
                    webworker.postMessage("");
                } else {
                    paintAll();
                }

                //message returned from the webworker
                webworker.onmessage = function (e) {
                    hideError();

                    webworkerInProgress = false;
                    paintAllDrawing = true;

                    var result = e.data.result;
                    $('#demo').html(result);

                    paintAllDrawing = false;
                    paintAllinProgress = false;

                    var demo = $("#demo svg");
                    var ratioWidth = demo.width() * previewScale;
                    var ratioHeight = demo.height() * previewScale;

                    $("#demo svg").css("width", zoomWidth + "%").css("height", zoomHeight + "%");

                    if (isFirst) {
                        $(".navbar").show();
                        $("#minimap").width(ratioWidth).height(ratioHeight).minimap( $("body") ).append('<div class="minimap-node" id="svg-preview"></div>');

                        paintingTimer = setInterval(doUpdate, interval); //initially set paintParts
                        isFirst = false;
                    }

                    $("#svg-preview").html(result);
                    $("#svg-preview svg").attr('width', ratioWidth + 'px').attr('height', ratioHeight + 'px');

                    $("#svg-preview svg #graph0 g text, #svg-preview svg #graph0 g polygon[fill='black']").remove();

                    $("#graph0 title").remove();
                };
            }
        }

        // to get the number of stage and edge IDs
        var edgeid = new RegExp(/" -> "/g); //edge ids
        var totalids = new RegExp (/label/g); //total ids

        var node = new RegExp(/label="([^"]+)"/g); //grabs the section
        var newline = new RegExp(/([^\n]+)/g); //grabs each line in the section
        var features = new RegExp(/\"(.*)\]/g); //grabs everything between " and ]

        var oldfeatureArray = [];
        var newfeatureArray = [];
        var eoldfeatureArray = [];
        var enewfeatureArray = [];

        function updateOnDifferent(oldArray, newArray) {
            var is_same = oldArray.length === newArray.length && oldArray.every(function(element, index) {
                return element === newArray[index];
            });
            if ((!is_same && !isFirst) && !paintAllinProgress) {
                doingUpdate = false;
                paintAll();
            }
            newArray = Array.from(oldArray); //assign old array to new array
            oldArray.length = 0; //empty old array so we can repeat the process
        }

        //function that updates the text values
        function paintParts(dot) {
            var numberOfEdgeIds  = dot.match(edgeid).length;   // Number of edge IDs
            var numberOfTotalIds = dot.match(totalids).length; // Number of total IDs
            var numberOfNodeIds = numberOfTotalIds - numberOfEdgeIds; //Number of node IDs
            var whole = dot.match(node); //section matches starting with label=" and ending with "
            var featureSection = dot.match(features); //grabs all features

            //updates paintAll for nodes depending on changes to color and thickness
            paintElement("node", 0, numberOfNodeIds, whole, featureSection, oldfeatureArray);
            updateOnDifferent(oldfeatureArray, newfeatureArray);

            //updates paintAll for edges depending on changes to color and thickness
            paintElement("edge", numberOfNodeIds, numberOfTotalIds, whole, featureSection, eoldfeatureArray);
            updateOnDifferent(eoldfeatureArray, enewfeatureArray);

            doingUpdate = false;

            return 0;
        }

        function paintElement(element, startIndex, stopIndex, whole, feature, oldArray) {
            //console.log("trying to paint part for " + element);
            var ss = 1;
            for (var s = startIndex; s < stopIndex; s++) {
                var iteration = whole[s].match(newline).map(function(item) {
                    var formattedSection = feature[s].replace(/"|]/g, '');
                    oldArray.push(formattedSection);
                    feature[s] = formattedSection;
                    //console.log("have match! " + feature[s]);
                    return item.replace(/label|"|=/g, '');
                });

                var sel = '#demo svg #' + element + ss;
                $(sel).children("text").each(function(itemIdx, item) {
                    if (itemIdx !== 0) { //skips title line which doesn't change
                        item = $(item);
                        if (item.text() !== iteration[itemIdx]) { //if there is a change in the html
                            if ((item.text().length !== iteration[itemIdx].length) && !paintAllinProgress) { //if the length is different redraw
                                doingUpdate = false;
                                paintAll();
                            }
                            item.text(iteration[itemIdx]);
                        }
                    }
                });
                ss++;
            }
        }

        paintAll(); //runs first initial paintAll();

        var saveData = (function () {
            var a = document.createElement("a");
            $("body").append("");
            a.style = "display: none";
            return function (data, fileName) {
                var blob = new Blob([data], {type: "octet/stream"}),
                    url = window.URL.createObjectURL(blob);
                a.href = url;
                a.download = fileName;
                a.click();
                window.URL.revokeObjectURL(url);
            };
        }());

        function zoom(factor) {
            zoomWidth += factor;
            zoomHeight += factor;
            $("#demo svg").css("width", zoomWidth + "%").css("height", zoomHeight + "%");
            $("body").scroll();
        }

        $(document).ready(function() {
            $("#refresh-rate-dropdown a").click(function () {
                $("#refresh-rate-dropdown a").removeClass("active");
                $(".refresh-label").html($(this).text());

                interval = $(this).data("interval");
                clearInterval(paintingTimer);

                if (interval > 0) paintingTimer = setInterval(doUpdate, interval);

                $(this).addClass("active");
            });

            $("#preview-btn").click(function () {
                $("#minimap").toggle("fast");
            });

            $("#zoom-in-btn").click(function () {
                //WIP!
                zoom(zoomStep);
            });

            $("#zoom-out-btn").click(function () {
                //WIP!
                zoom(zoomStep * -1);
            });

            $("#download-btn").click(function() {
                var date = new Date();
                var year = date.getFullYear().toString();
                var month = (date.getMonth()+1).toString();
                var day = date.getDate().toString();
                var hour = date.getHours().toString();
                var min = date.getMinutes().toString();
                var sec = date.getSeconds().toString();
                saveData($("#demo").html(), `telemetry_${year}-${month}-${day}_${hour}-${min}-${sec}.svg`);
            });
        });
    </script>
</body>
</html>